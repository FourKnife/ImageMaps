!function(a){"function"==typeof define&&define.amd?define(["jquery"],a):a("object"==typeof exports?require("jquery"):jQuery)}(function(a){"use strict";function g(c,d){this.container=a(c),this.mapEl=null,this.svgEl=null,this.options=a.extend(!0,{},b,d),this.shapeType=this.options.shape,this.isEditMode=this.options.isEditMode,this.shapeStyle=this.options.shapeStyle,this.shapeText="",this.shapeImageUrl="",this.shapeCoords=null,this.vertexCoords=null,this.grabType=null,this.containerWidth=0,this.containerHeight=0,this.touchStartCoords={x:null,y:null},this.dragInfo={face:{x:null,y:null},vertex:{x:null,y:null}},this.shapeLimitCoords={x:30,y:30,radius:15},this.allShapeInfo={}}function h(b,d){var e=J();if(this.container.attr("usemap")){var f=this.container.attr("usemap").replace("#","");this.mapEl=a("body").find("map[name="+f+"]")}else this.mapEl=a("<map name="+e+"></map>").insertAfter(this.container),this.container.attr("usemap","#"+e);this.containerWidth=this.container.width(),this.containerHeight=this.container.height();var g=this.containerWidth,h=this.containerHeight,k=g/2,l=h/2,n=this.shapeType,o=[],p=!1;if(b=I(b),b instanceof Array)"rect"===n||"image"===n?o=a.extend([],c.rect,b):"circle"===n?o=a.extend([],c.circle,b):"ellipse"===n?o=a.extend([],c.ellipse,b):"text"===n&&(b[0]||(b[0]=k,p=!0),b[1]||(b[1]=l,p=!0),b[2]||(b[2]=20),o=a.extend([],c.text,b));else{var q=.1*g,r=.1*h,s=q>=r?r:q;if("rect"===n)o=a.extend([],c.rect,[k-q,l-r,k+q,l+r]);else if("circle"===n)o=a.extend([],c.circle,[k,l,s]);else if("ellipse"===n)o=a.extend([],c.ellipse,[k,l,s,s]);else if("image"===n){var t=K(this.shapeImageUrl);q=t.width/2,r=t.height/2,o=[k-q,l-r,k+q,l+r]}}var u=this.mapEl.find("._shape_face").length,v=n,w={};"text"!==n&&"image"!==n||(v="rect",w="text"===n?{text:this.shapeText}:{href:this.shapeImageUrl}),i.call(this,o,e,d,u),this.setShapeCoords(o),this.updateShapeInfo(u,{coords:o,type:n,url:d,style:this.shapeStyle},w),p&&this.isEditMode&&"text"===n&&m.call(this),"ellipse"===n&&(v="circle",o=[o[0],o[1],c.ellipse[2],c.ellipse[2]]),j.call(this,v,o,d,u)}function i(b,c,d,g){var h=this.container.width(),i=this.container.height();if("undefined"!=typeof document.createElementNS){var j=this.mapEl.find("svg").get(0),l=a(j),m=this.shapeType;j||(j=document.createElementNS(e,"svg"),l=a(j),this.svgEl=l,this.isEditMode?this.attachEvents(l,[{type:"mousedown",handler:u}]):this.attachEvents(this.mapEl,[{type:"touchstart",handler:s},{type:"click touchend",handler:t}]),this.attachEvents(window,[{type:"resize",handler:x}])),j.setAttribute("width",h),j.setAttribute("height",i);var n=this.container.position();l.attr({xmlns:e,"xmlns:xlink":f,version:"1.1","data-Id":c}).css({position:"absolute",zIndex:1e3,overflow:"hidden",top:n.top,left:n.left});var o=k.call(this,m,b,d,g);l.append(o),this.mapEl.append(l)}}function j(b,c,d,e){a("<area shape="+b+" coords="+c.join(",")+" href="+(d||"#")+" data-index="+e+" "+(d?'target="_blank"':"")+">").appendTo(this.mapEl)}function k(b,c,d,f){"poly"===b&&(b="polyline");var g=a(document.createElementNS(e,b)),h=a(document.createElementNS(e,"g"));l.call(this,c,g);var i="default";if(this.isEditMode?i="move":""!==d&&(i="pointer"),this.setShapeStyle({cursor:i}),g.css(this.shapeStyle),"text"===b&&g.css({"fill-opacity":"","stroke-opacity":""}),g.attr("data-index",f),h.append(g),this.setShapeElement(g),this.isEditMode&&"text"!==b){for(var j=n(b,c,f),k=0,m=j.length;k<m;k++)j[k].appendTo(h);this.setVertexElements(j)}return h}function l(a,b,c){b=b||this.shapeEl;var d=c?c.type:this.shapeType;"rect"===d||"image"===d?(b.attr({x:a[0],y:a[1],class:"_shape_face"}),a[2]&&b.attr("width",a[2]-a[0]),a[3]&&b.attr("height",a[3]-a[1]),"image"===d&&(b.get(0).setAttributeNS(f,"href",c?c.href:this.shapeImageUrl),b.get(0).setAttribute("preserveAspectRatio","none"))):"circle"===d?(b.attr({cx:a[0],cy:a[1],class:"_shape_face"}),a[2]&&b.attr("r",a[2])):"ellipse"===d?(b.attr({cx:a[0],cy:a[1],class:"_shape_face"}),a[2]&&b.attr("rx",a[2]),a[3]&&b.attr("ry",a[3])):"text"===d&&(b.attr({x:a[0],y:a[1],"font-size":a[2],class:"_shape_face"}),b.text(this.shapeText))}function m(){var a=this.shapeEl,b=a.get(0).getBBox(),c=b.width/2,e=parseFloat(a.attr("font-size"))*d/2,f=parseInt(a.attr("x"),10),g=parseInt(a.attr("y"),10),h=f-c,i=g+e;this.updateShapeInfo(a.data("index"),{coords:[h,i,a.attr("font-size")]}),a.attr({x:h,y:i})}function n(b,c,d){for(var f=null,g=[],h=p(b,c),i=0,j=h.length;i<j;i++)f=a(document.createElementNS(e,"rect")),f.attr("data-index",d).css({fill:"#ffffff",stroke:"#000000","stroke-width":2}),g.push(f);return o(h,g,b),g}function o(b,c,d){for(var e=0,f=b.length;e<f;e++){var g=b[e];a(c[e]).attr({x:g.x-3,y:g.y-3,width:7,height:7,"data-direction":g.type,class:"_shape_vertex"}).css("cursor",r(g.type))}}function p(a,b){var c=[];return"rect"===a||"image"===a?c=[{x:b[0],y:b[1],type:"nw"},{x:b[0],y:b[3],type:"sw"},{x:b[2],y:b[1],type:"ne"},{x:b[2],y:b[3],type:"se"},{x:(b[2]-b[0])/2+b[0],y:b[1],type:"n"},{x:(b[2]-b[0])/2+b[0],y:b[3],type:"s"},{x:b[0],y:(b[3]-b[1])/2+b[1],type:"w"},{x:b[2],y:(b[3]-b[1])/2+b[1],type:"e"}]:"circle"===a?c=[{x:b[0],y:b[1]-b[2],type:"n"},{x:b[0],y:b[1]+b[2],type:"s"},{x:b[0]-b[2],y:b[1],type:"w"},{x:b[0]+b[2],y:b[1],type:"e"}]:"ellipse"===a&&(c=[{x:b[0],y:b[1]-b[3],type:"n"},{x:b[0],y:b[1]+b[3],type:"s"},{x:b[0]-b[2],y:b[1],type:"w"},{x:b[0]+b[2],y:b[1],type:"e"}]),c}function q(a,b,d){var e=this.svgEl.find('._shape_face[data-index="'+b.data("index")+'"]');d=d||this.shapeType,"text"===d?a=H(e):"ellipse"===d&&(a=[a[0],a[1],c.ellipse[2]]),b.attr("coords",a.join(","))}function r(a){return a+"-resize"}function s(a){var b=a.originalEvent.touches[0];this.touchStartCoords.x=b.pageX,this.touchStartCoords.y=b.pageY}function t(b){if("area"!==b.currentTarget.tagName.toLowerCase()){if(b.preventDefault(),this.dragInfo.face.x&&this.dragInfo.face.x!==b.pageX||this.dragInfo.face.y&&this.dragInfo.face.y!==b.pageY||"svg"===b.target.tagName.toLowerCase()||"touchend"===b.type&&b.originalEvent.changedTouches[0].pageX!==this.touchStartCoords.x&&b.originalEvent.changedTouches[0].pageY!==this.touchStartCoords.y)return;var c=a(b.target),d=c.attr("data-index"),e=this.mapEl.find('area[data-index="'+d+'"]'),f=e.attr("href");"#"!==f&&window.open(e.attr("href"))}this.options.onClick.call(this,b,e.attr("href"))}function u(b){if(b.preventDefault(),"svg"!==b.target.tagName.toLowerCase()){var c=a(b.target),d=c.attr("data-index"),e=this.getShapeInfo(d),f=c.parent(),g=f.find(":first-child"),h=[],i=g.get(0).tagName.toLowerCase();if("rect"===i||"image"===i){var j=parseInt(g.attr("x"),10),k=parseInt(g.attr("y"),10);h=[j,k,j+parseInt(g.attr("width"),10),k+parseInt(g.attr("height"),10)],"image"===i&&this.setImageShape(g.attr("href"))}else if("circle"===i){var j=parseInt(g.attr("cx"),10),k=parseInt(g.attr("cy"),10);h=[j,k,parseInt(g.attr("r"),10)]}else if("ellipse"===i){var j=parseInt(g.attr("cx"),10),k=parseInt(g.attr("cy"),10);h=[j,k,parseInt(g.attr("rx"),10),parseInt(g.attr("ry"),10)]}else if("text"===i){var j=parseFloat(g.attr("x")),k=parseFloat(g.attr("y")),l=parseFloat(g.attr("font-size"));h=[j,k,l],this.shapeText=g.text()}else"polygon"===i&&(i="poly");if(this.setShapeType(i),this.setShapeElement(g),this.setShapeCoords(h),"text"!==i){g.attr("data-fill",g.css("fill")),g.css("fill","#ffffff"),this.setVertexCoords(p(i,h));var m=[],n=this.mapEl.find('._shape_vertex[data-index="'+d+'"]');n.each(function(){m.push(a(this))}),this.setVertexElements(m)}c.is("._shape_face")?(this.grabType="face",z.call(this,c,b.pageX,b.pageY)):c.is("._shape_vertex")&&(this.grabType="vertex",C.call(this,c,d)),this.attachEvents(this.mapEl.parent(),[{type:"mouseup",handler:v},{type:"mousemove",handler:w}]),this.options.onSelect.call(this,b,e),this.options.onMouseDown.call(this,b,i,h)}}function v(b){var c=a(b.target),d=this.shapeEl;d.css("fill",d.attr("data-fill")),c.attr("data-movable",!1);var e=B.call(this);this.setShapeCoords(e),this.updateShapeInfo(d.data("index"),{coords:e}),this.detachEvents(this.mapEl.parent(),[{type:"mouseup",handler:v},{type:"mousemove",handler:w}]),this.options.onMouseUp.call(this,b,this.shapeType,e)}function w(b){var c=a(b.target),d=this.shapeCoords[0],e=this.shapeCoords[1],f=this.grabType,g=this.shapeType,h={};if("face"===f||"vertex"===f){if("face"===f){var i=d+b.pageX,j=e+b.pageY;h=A.call(this,i-this.dragInfo.face.x,j-this.dragInfo.face.y)}else"vertex"===f&&(h=D.call(this,b.pageX-this.svgEl.offset().left,b.pageY-this.svgEl.offset().top));"text"!==g&&(this.setVertexCoords(h.vertexCoords),o(h.vertexCoords,this.vertexEls,this.shapeType));var k=parseInt(h.grabEl.attr("data-index"),10);l.call(this,h.movedCoords,this.svgEl.find('._shape_face[data-index="'+k+'"]')),q.call(this,h.movedCoords,this.mapEl.find('area[data-index="'+k+'"]')),(c.is("._shape_face")||c.is("._shape_vertex"))&&(Math.abs(this.dragInfo.face.x-b.pageX)<=1||Math.abs(this.dragInfo.face.y-b.pageY)<=1)&&this.svgEl.append(c.parent()),this.options.onMouseMove.call(this,b,g,h.movedCoords)}}function x(a){var b=this.container.width(),c=this.container.height();this.containerWidth===b&&this.containerHeight===c||(y.call(this,b,c),this.containerWidth=b,this.containerHeight=c)}function y(b,c){var d=this,e=this.allShapeInfo,f=b/this.containerWidth,g=c/this.containerHeight;this.svgEl.get(0).setAttribute("width",b),this.svgEl.get(0).setAttribute("height",c),a.each(e,function(a,b){b.coords=G(b.coords,b.type,f,g),o(p(b.type,b.coords),d.svgEl.find('._shape_vertex[data-index="'+b.index+'"]'),b.type),l.call(d,b.coords,d.svgEl.find('._shape_face[data-index="'+b.index+'"]'),b),q.call(d,b.coords,d.mapEl.find('area[data-index="'+b.index+'"]'),b.type)})}function z(a,b,c){this.dragInfo.face.x=b,this.dragInfo.face.y=c,a.attr("data-movable",!0)}function A(a,b){var c=this.shapeEl;if("false"!==c.attr("data-movable")){var d=[],e=[],f=this.shapeType;if("rect"===f||"image"===f){var g=parseInt(c.attr("width"),10),h=parseInt(c.attr("height"),10),i=a+g,j=b+h;d=[a,b,i,j],e=p("rect",d)}else"circle"===f?(d=[a,b,parseInt(c.attr("r"),10)],e=p("circle",d)):"ellipse"===f?(d=[a,b,parseInt(c.attr("rx"),10),parseInt(c.attr("ry"),10)],e=p("ellipse",d)):"text"===f&&(d=[a,b]);return{movedCoords:d,vertexCoords:e,grabEl:c}}}function B(){var a=this.shapeEl,b=this.shapeType,c=[];if("rect"===b||"image"===b){var d=parseInt(a.attr("x"),10),e=parseInt(a.attr("y"),10);c=[d,e,d+parseInt(a.attr("width"),10),e+parseInt(a.attr("height"),10)]}else"circle"===b?c=[parseInt(a.attr("cx"),10),parseInt(a.attr("cy"),10),parseInt(a.attr("r"),10)]:"ellipse"===b?c=[parseInt(a.attr("cx"),10),parseInt(a.attr("cy"),10),parseInt(a.attr("rx"),10),parseInt(a.attr("ry"),10)]:"text"===b&&(c=[parseInt(a.attr("x"),10),parseInt(a.attr("y"),10)]);return c}function C(a,b){this.setVertexElement(a);var c=0;this.vertexEls.forEach(function(b,d){a.get(0)===b.get(0)&&(c=d)});var d=this.vertexCoords[c];this.dragInfo.vertex.x=d.x,this.dragInfo.vertex.y=d.y,a.attr("data-movable",!0)}function D(a,b){if("false"!==this.vertexEl.attr("data-movable")){var c=[],d=[],e=this.shapeType,f=this.vertexEl.attr("data-direction");if("rect"===e||"image"===e)switch(f){case"nw":c=E.call(this,[a,b,this.shapeCoords[2],this.shapeCoords[3]],f);break;case"sw":c=E.call(this,[a,this.shapeCoords[1],this.shapeCoords[2],b],f);break;case"ne":c=E.call(this,[this.shapeCoords[0],b,a,this.shapeCoords[3]],f);break;case"se":c=E.call(this,[this.shapeCoords[0],this.shapeCoords[1],a,b],f);break;case"n":c=E.call(this,[this.shapeCoords[0],b,this.shapeCoords[2],this.shapeCoords[3]],f);break;case"s":c=E.call(this,[this.shapeCoords[0],this.shapeCoords[1],this.shapeCoords[2],b],f);break;case"w":c=E.call(this,[a,this.shapeCoords[1],this.shapeCoords[2],this.shapeCoords[3]],f);break;case"e":c=E.call(this,[this.shapeCoords[0],this.shapeCoords[1],a,this.shapeCoords[3]],f)}else if("circle"===e)switch(f){case"n":c=[this.shapeCoords[0],this.shapeCoords[1],F.call(this,this.shapeCoords[1]-b)];break;case"s":c=[this.shapeCoords[0],this.shapeCoords[1],F.call(this,b-this.shapeCoords[1])];break;case"w":c=[this.shapeCoords[0],this.shapeCoords[1],F.call(this,this.shapeCoords[0]-a)];break;case"e":c=[this.shapeCoords[0],this.shapeCoords[1],F.call(this,a-this.shapeCoords[0])]}else if("ellipse"===e)switch(f){case"n":c=[this.shapeCoords[0],this.shapeCoords[1],this.shapeCoords[2],F.call(this,this.shapeCoords[1]-b)];break;case"s":c=[this.shapeCoords[0],this.shapeCoords[1],this.shapeCoords[2],F.call(this,b-this.shapeCoords[1])];break;case"w":c=[this.shapeCoords[0],this.shapeCoords[1],F.call(this,this.shapeCoords[0]-a),this.shapeCoords[3]];break;case"e":c=[this.shapeCoords[0],this.shapeCoords[1],F.call(this,a-this.shapeCoords[0]),this.shapeCoords[3]]}else"poly"===shapetype;return d=p(e,c),{movedCoords:c,vertexCoords:d,grabEl:this.vertexEl}}}function E(a,b){var c=a[0],d=a[1],e=a[2],f=a[3];return e-c<=this.shapeLimitCoords.x&&("se"!==b&&"ne"!==b&&"e"!==b||(e=c+this.shapeLimitCoords.x),"nw"!==b&&"sw"!==b&&"w"!==b||(c=e-this.shapeLimitCoords.x)),f-d<=this.shapeLimitCoords.y&&("se"!==b&&"sw"!==b&&"s"!==b||(f=d+this.shapeLimitCoords.y),"nw"!==b&&"ne"!==b&&"n"!==b||(d=f-this.shapeLimitCoords.y)),[c,d,e,f]}function F(a){var b=this.shapeCoords[2];return b=a<=this.shapeLimitCoords.radius?this.shapeLimitCoords.radius:a}function G(a,b,c,d){var e=[];if("rect"===b||"image"===b||"ellipse"===b)e=[a[0]*c,a[1]*d,a[2]*c,a[3]*d];else if("circle"===b){var f=1;f=c>=d?d:c,1===c&&(f=d),1===d&&(f=c),e=[a[0]*c,a[1]*d,a[2]*f]}else"text"===b&&(e=[a[0]*c,a[1]*d,a[2]*c]);return e}function H(a){var b=parseFloat(a.attr("x")),c=parseFloat(a.attr("y")),e=a.get(0).getBBox(),f=e.width,g=parseFloat(a.attr("font-size"))*d/2;return[b,c-g,b+f,c]}function I(a){if(!a)return null;for(var b=[],c=0,d=a.length;c<d;c++)b.push(parseFloat(a[c]));return b}function J(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function K(a){var b=new Image;return"naturalWidth"in b&&"string"!=typeof a?{width:a.naturalWidth,height:a.naturalHeight}:(b.src=a.src||a,{width:b.width,height:b.height})}var b={isEditMode:!1,shape:"rect",shapeText:"press on link",shapeStyle:{fill:"#ffffff","fill-opacity":.2,stroke:"#ffffff","stroke-width":3},onClick:a.noop,onMouseDown:a.noop,onMouseMove:a.noop,onMouseUp:a.noop,onSelect:a.noop},c={rect:[0,0,20,20],circle:[0,0,10],ellipse:[0,0,5,5],text:[0,0,12]},d=.5,e="http://www.w3.org/2000/svg",f="http://www.w3.org/1999/xlink";g.prototype.createMaps=function(b,c){var d=this.container.width();isNaN(d)||!d?this.container.one("load",a.proxy(h,this,b,c)):h.call(this,b,c)},g.prototype.setShapeType=function(a){this.shapeType=a},g.prototype.setShapeStyle=function(b){b=b||{},this.shapeStyle=a.extend({},!0,this.shapeStyle,b)},g.prototype.setUrl=function(a,b){},g.prototype.setTextShape=function(a,b){this.setShapeStyle(b),this.shapeText=a},g.prototype.setImageShape=function(a,b){this.setShapeStyle(b),this.shapeImageUrl=a},g.prototype.addShape=function(a,b,c){!!c&&this.setShapeType(c),this.createMaps(a,b)},g.prototype.removeShape=function(a){if(this.shapeEl){"undefined"==typeof a&&(a=this.shapeEl.data("index"));var b=this.mapEl.find('area[data-index="'+a+'"]'),c=this.svgEl.find('._shape_face[data-index="'+a+'"]');this.detachEvents(c,[{type:"click touchend"}]),c.parent().remove(),b.remove(),this.removeShapeInfo(a)}},g.prototype.removeAllShapes=function(){if(this.shapeEl){for(var b=this.svgEl.find("._shape_face"),c=0,d=b.length;c<d;c++)this.removeShape(a(b[c]).data("index"));this.allShapeInfo={}}},g.prototype.removeImageMaps=function(){this.removeAllShapes(),this.svgEl&&this.svgEl.remove()},g.prototype.updateShapeInfo=function(b,c,d){var e=this.allShapeInfo;c.index=b,e["shape"+b]?e["shape"+b]=a.extend(!0,{},e["shape"+b],c,d):e["shape"+b]=a.extend(!0,c,d)},g.prototype.removeShapeInfo=function(a){delete this.allShapeInfo["shape"+a]},g.prototype.getShapeInfo=function(a){return this.allShapeInfo["shape"+a]},g.prototype.getAllShapesInfo=function(){return a.extend(!0,{},this.allShapeInfo)},g.prototype.getCoordsByRatio=function(a,b,c,d){return G(a,b,c,d)},g.prototype.enableClick=function(){this.attachEvents(this.svgEl.find("._shape_face"),[{type:"touchstart",handler:s},{type:"click touchend",handler:t}])},g.prototype.disableClick=function(){this.detachEvents(this.svgEl.find("._shape_face"),[{type:"touchstart",handler:s},{type:"click touchend",handler:t}])},g.prototype.setShapeCoords=function(a){this.shapeCoords=a},g.prototype.setVertexCoords=function(a){this.vertexCoords=a},g.prototype.setShapeElement=function(a){this.shapeEl=a},g.prototype.setVertexElement=function(a){this.vertexEl=a},g.prototype.setVertexElements=function(a){this.vertexEls=a},g.prototype.attachEvents=function(b,c){b=a(b);for(var d=0,e=c.length;d<e;d++)b.on(c[d].type+".area",a.proxy(c[d].handler,this))},g.prototype.detachEvents=function(b,c){b=a(b);for(var d=0,e=c.length;d<e;d++){var f=c[d].type||"",g=c[d].handler?a.proxy(c[d].handler,this):"";g?b.off(f+".area",g):b.off(f+".area")}},a.fn.extend({createMaps:function(a,b){return this.data("image_maps_inst").createMaps(a,b),this},addShape:function(a,b,c){return this.data("image_maps_inst").addShape(a,b,c),this},removeShape:function(a){return this.data("image_maps_inst").removeShape(a),this},removeAllShapes:function(){this.data("image_maps_inst").removeAllShapes()},destroy:function(){var a=this.data("image_maps_inst");a&&(a.removeImageMaps(),delete this.data("image_maps_inst"),this.data("image_maps_inst",null))},setShapeStyle:function(a){return this.data("image_maps_inst").setShapeStyle(a),this},setUrl:function(a,b){return this.data("image_maps_inst").setUrl(a,b),this},setTextShape:function(a,b){return this.data("image_maps_inst").setTextShape(a,b),this},setImageShape:function(a,b){return this.data("image_maps_inst").setImageShape(a,b),this},enableClick:function(){this.data("image_maps_inst").enableClick()},disableClick:function(){this.data("image_maps_inst").disableClick()},getAllShapes:function(){return this.data("image_maps_inst").getAllShapesInfo()},getCoordsByRatio:function(a,b,c,d){return this.data("image_maps_inst").getCoordsByRatio(a,b,c,d)}}),a.fn.imageMaps=function(a){if(1===this.length){if(!this.data("image_maps_inst")){var b=new g(this,a);return this.data("image_maps_inst",b),b}return this.data("image_maps_inst")}if(this.length>1)throw new Error("Already imageMaps instance has been created.")}});
